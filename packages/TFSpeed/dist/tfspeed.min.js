/*!
    * tfspeed v1.0.2
    * (c) 2019 wilsonliuxyz@gmail.com
    * @description front end speed
    * @license MIT
    */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.tfspeed=t()}(this,function(){"use strict";function e(e){if(this._events={},!e||!e.pageStartTime)return this._throwError("new Speed error need pageStartTime");this.performance=window.performance||window.mozPerformance||window.msPerformance||window.webkitPerformance,this.startTimeMap={},this._getSupportType(),this.pageLife={logType:1,cgi:0,resource:0,codeExec:0},this.otherTypeList=[],this.resourceList=[],this.clearResourceIndex=0,this.resourceRegMap=e.resourceRegMap||{img:/\.(png|jpg|jpeg|gif|svg)$/,css:/\.css$/,script:/\.js$/},this.isSendPageLife=!1,this.isSendOtherType=!1,this.utils.extend(this,e),this.naviStartTime||(this.naviStartTime=this.pageStartTime,1<this.perfType&&(this.naviStartTime=this.performance.timing.navigationStart)),this.init&&this.init()}return e.prototype={_throwError:function(e,t){this.emit("throwError",e,t),console.warn&&console.warn("#Speed#",e,t)},utils:{extend:function(e,t){var r;for(r in t)t.hasOwnProperty(r)&&(e[r]=t[r])}},on:function(e,t){this._events[e]||(this._events[e]=[]),this._events[e].push(t)},off:function(e,t){var r;this._events[e]&&(t?-1<(r=this._events[e].indexOf(t))&&this._events[e].splice(r,1):delete this._events[e])},emit:function(e){var t=arguments;if(this._events[e]){var r=0,i=this._events[e].length;if(i)for(;r<i;r++)this._events[e][r].apply(this,[].slice.call(t,1))}},_getSupportType:function(){this.perfType=1,this.performance&&this.performance.timing&&(this.perfType=2,!this.performance.getEntries&&(this.perfType=3),!this.performance.clearResourceTimings&&(this.perfType=4))},startMark:function(e){try{if(!e)return this._throwError("startMark need keyName");this.startTimeMap[e]&&this._throwError("startMark has the same keyName "+e),this.startTimeMap[e]=Date.now()}catch(e){this._throwError("startMark throw error",e)}},endMark:function(e,t){if(!e)return this._throwError("endMark need keyName");var r,i,s,o=Date.now(),n={keyName:e},a=t.url;delete t.url;try{if(this.utils.extend(n,t),t.duration)void 0===t.startTime&&(n.startTime=o-this.naviStartTime-t.duration);else{if(!this.startTimeMap[e])return this._throwError("endMark need startTime with "+e);n.duration=o-this.startTimeMap[e],n.startTime=this.startTimeMap[e]-this.naviStartTime,delete this.startTimeMap[e]}if(a?(n.logType=2,this.pageLife.cgi++):(n.logType=3,this.pageLife.codeExec++),a&&3<=this.perfType)for(r=this.performance.getEntries(),s=0;s<r.length;s++)!(i=r[s])||i&&i.hasDelete||i&&i.name&&-1!==i.name.indexOf(a)&&(n.initiatorType=i.initiatorType,n.transferSize=i.transferSize,n.encodedBodySize=i.encodedBodySize,n.decodedBodySize=i.decodedBodySize,n.startTime=Math.floor(i.startTime||i.fetchStart),n.responseEnd=Math.floor(i.responseEnd),n.duration=Math.floor(i.duration));this.otherTypeList.push(n)}catch(e){this._throwError("endMark throw error",e)}},markResource:function(){var e,t,r,i,s,o,n;try{if(this.perfType<3)return this._throwError("markResourcePerf need support performance.getEntries");for(e=this.performance.getEntries(),this.resourceList=[],t=0;t<e.length;t++)if(!(!(i=e[t])||i&&i.hasDelete)){for(r in s=i.name&&i.name.split("?")&&i.name.split("?")[0],o=null,this.resourceRegMap)this.resourceRegMap[r].test(s)&&(o=r);o&&((n={logType:4,keyName:i.name.split("?")[0],initiatorType:i.initiatorType,type:o,transferSize:i.transferSize,encodedBodySize:i.encodedBodySize,decodedBodySize:i.decodedBodySize}).startTime=Math.floor(i.startTime||i.fetchStart),n.responseEnd=Math.floor(i.responseEnd),n.duration=Math.floor(i.duration),this.pageLife.resource++,this.resourceList.push(n))}}catch(e){return this._throwError("markResource throw error",e)}},clearResource:function(){var e,t;try{if(3===this.perfType)for(t=this.performance.getEntries(),e=0;e<t.length;e++)t[e].hasDelete=!0;else 4===this.perfType&&this.performance.clearResourceTimings()}catch(e){}},markPageLife:function(e){try{e&&(this.title=this.pageLife.title=e),this.pageLife.render=Date.now()-this.pageStartTime,this.pageLife.startTime=this.pageStartTime-this.naviStartTime,this.emit("markPageLife",this.pageLife)}catch(e){this._throwError("markPageLife error",e)}},getPageLifeTime:function(){if(1===this.perfType)return!1;var e,t,r,i,s=["domainLookupStart","domainLookupEnd","connectStart","connectEnd","requestStart","responseStart","responseEnd","domInteractive","domComplete","domContentLoadedEventEnd","loadEventEnd","duration"];for(3<=this.perfType?(e=performance.getEntries()[0],this.pageLife.type=e.type,this.pageLife.transferSize=e.transferSize,this.pageLife.encodedBodySize=e.encodedBodySize,this.pageLife.decodedBodySize=e.decodedBodySize):2===this.perfType&&(e=performance.timing),t=0;t<s.length;t++)i=e[r=s[t]],2===this.perfType&&(i=e[r]-this.naviStartTime),this.pageLife[r]=Math.floor(i)},extendPageLife:function(e){try{if(!e)return this._throwError("extendPageLife attr is null");this.emit("extendPageLife",e),this.utils.extend(this.pageLife,e)}catch(e){this._throwError("report throw error",e)}},report:function(){var e=[];try{return this.emit("beforeReport"),this.isSendPageLife&&e.push(this.pageLife),this.isSendOtherType&&(e=e.concat(this.otherTypeList,this.resourceList)),this.emit("afterSample",e),e}catch(e){this._throwError("report throw error",e)}}},e});