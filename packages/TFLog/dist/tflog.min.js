/*!
    * tflog v1.0.5
    * (c) 2019 wilsonliuxyz@gmail.com
    * @description tflog
    * @license MIT
    */
!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):e.tflog=r()}(this,function(){"use strict";var i={INITING:1,INITED:2,FAILED:3},u={isSupportIndexedDB:function(){var e;try{return self===top&&((e=!!(window.indexedDB&&window.IDBTransaction&&window.IDBKeyRange))&&(window.IDBTransaction.READ_WRITE="readwrite",window.IDBTransaction.READ_ONLY="readonly"),e)}catch(e){return!1}}(),status:i.INITING,database:"TFLog",pool:[],recordPool:[],recordLock:!1};function a(e,r){var t,n={};if(0==(r=null==r?5:r))return"";r--;try{if("function"==typeof e)return e.toString();if("object"!=typeof e)return e;for(t in e)e.hasOwnProperty(t)&&("function"==typeof e[t]||o(e[t])||(n[t]=a(e[t],r)));return n}catch(e){return{error:"filterFunction error"}}}function o(r){try{return r instanceof HTMLElement||r instanceof SVGElement||r instanceof Element}catch(e){return"object"==typeof r&&1===r.nodeType&&"object"==typeof r.style&&"object"==typeof r.ownerDocument}}function n(e,r){if(!(e=String(e))||/^\d{13}$/.test(e))return+e;if(r&&!/^\d{13}$/.test(r))throw new TypeError("relative time should be standard unix timestamp");return(r||Date.now())-24*e.replace(/d$/,"")*3600*1e3}function s(e,r){u.status=i.FAILED;var t="";try{r&&(e=e+":"+(r.message||r.stack||r.name),t=r.toString())}catch(e){t="try-catch"}console.__error&&console.__error("#TFLog throwError#",e,t)}function e(e){this.namespace=e}function t(e,r,t,n){c(e,r,t,n),"console"!==e&&(n&&"object"==typeof n&&0!==n.length?console["__"+r]&&console["__"+r](e,t,n):console["__"+r]&&console["__"+r](e,t))}function c(e,r,t,n){var o;try{if(u.status===i.FAILED)return u.pool=[],!(u.recordPool=[]);if(u.status===i.INITING)return u.pool.push(function(){return c(e,r,t,n)});if(u.recordLock)return u.recordPool.push(function(){return c(e,r,t,n)});if(u.recordLock=!0,!(o=d()))return s("getTransaction is null");o.objectStore("logs").add({time:Date.now(),level:r,namespace:e,descriptor:a(t),data:a(n)}).onsuccess=function(){var e;u.recordLock=!1;try{u.recordPool=u.recordPool||[],(e=u.recordPool.shift())&&e()}catch(e){}}}catch(e){s("indexeddb_record",e)}}function d(){var e,r=!1;try{return e=u.db.transaction(["logs"],IDBTransaction.READ_WRITE||"readwrite"),r=!1,e.onerror=function(e){return e.stopPropagation(),r=!0,s("indexeddb_record_transaction",e.target.error)},e.onabort=function(e){e.stopPropagation(),!r&&s("indexeddb_record_transaction_onabort",e.target.error),e.target.error&&"QuotaExceededError"===e.target.error.name&&l()},e}catch(e){s("getTransaction",e)}}function l(){try{u.status=i.FAILED,u.db&&u.db.close(),window.indexedDB.deleteDatabase(u.database).onerror=function(e){return s("clean_error",e.target.error)}}catch(e){s("indexeddb_clean",e)}}return e.prototype={varStorage:u,log:function(e,r){t(this.namespace,"log",e,r)},warn:function(e,r){t(this.namespace,"warn",e,r)},error:function(e,r){t(this.namespace,"error",e,r)}},function(){var e;try{if(!u.isSupportIndexedDB||u.status!==i.INITING)return;(e=window.indexedDB.open(u.database,1)).onerror=function(e){s("protocol indexeddb is prevented.",e.target.error),e.target.error&&"QuotaExceededError"===e.target.error.name&&l()},e.onsuccess=function(e){u.db=e.target.result,u.status=i.INITED,u.db.onclose=function(e){return s("indexeddb_init_success_onclose",e.target.error)},u.db.onabort=function(e){return s("indexeddb_init_success_onabort",e.target.error)},u.db.onerror=function(e){return s("indexeddb_init_success_onerror",e.target.error)},function(e){var r=(e=e||[]).shift();try{for(;r;)r(),r=e.shift()}catch(e){}}(u.pool)},e.onblocked=function(){return s("indexeddb_init_blocked")},e.onupgradeneeded=function(e){var r;try{if(u.db=e.target.result,!u.db)return s("onupgradeneeded_is_null");u.db.objectStoreNames.contains("logs")||((r=u.db.createObjectStore("logs",{autoIncrement:!0})).createIndex("namespace","namespace",{unique:!1}),r.createIndex("level","level",{unique:!1}),r.createIndex("descriptor","descriptor",{unique:!1}),r.createIndex("data","data",{unique:!1}))}catch(e){s("indexeddb_init_onupgradeneeded",e)}}}catch(e){s("indexeddb_init",e)}}(),e.keep=function e(n){var r,o,t;try{if(u.status===i.FAILED)return!(u.pool=[]);if(u.status===i.INITING)return u.pool.push(function(){return e(n)});if(!(r=d()))return s("getTransaction is null");o=r.objectStore("logs"),n?((t=o.openCursor()).onsuccess=function(e){var r=Date.now()-24*n*3600*1e3,t=e.target.result;t&&t.value&&t.value.time<r&&(o.delete(t.primaryKey),t.continue())},t.onerror=function(e){return s("unable to locate logs earlier than "+n+"d.",e.target.error)}):o.clear().onerror=function(e){return s("indexedb_keep_clear",e.target.error)}}catch(e){s("indexeddb_keep",e)}},e.clean=l,e.get=function e(o,a,c){var r,t;try{if(u.status===i.FAILED)return!(u.pool=[]);if(1===arguments.length?(c=o,o=void 0):2===arguments.length&&(c=a,a=void 0),u.status===i.INITING)return u.pool.push(function(){return e(o,a,c)});if(o=n(o),a=n(a),!(r=d()))return s("getTransaction is null");(t=r.objectStore("logs")).getAll?t.getAll().onsuccess=function(e){var r,t=[],n=0;if(r=e.target.result)for(;n<r.length;n++)!r[n]||o&&r[n].time<o||a&&r[n].time>a||t.push(r[n]);c(t)}:t.openCursor().onsuccess=function(e){var r=e.target.result,t=[];if(r){if(!r.value||o&&r.value.time<o||a&&r.value.time>a)return r.continue();t.push({time:r.value.time,level:r.value.level,namespace:r.value.namespace,descriptor:r.value.descriptor,data:r.value.data}),r.continue()}else c(t)}}catch(e){s("indexeddb_get",e)}},e.record=c,e});